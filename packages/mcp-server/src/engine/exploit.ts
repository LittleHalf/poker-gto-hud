import type { GameState } from '../tools/adviser.js'
import type { GtoResult } from './gto.js'

export interface RawStats {
  vpip_num: number
  vpip_denom: number
  pfr_num: number
  pfr_denom: number
  af_bets: number
  af_calls: number
  cbet_fold_num: number
  cbet_fold_denom: number
  fold_to_3bet_num: number
  fold_to_3bet_denom: number
  wtsd_num: number
  wtsd_denom: number
}

export type ExploitResult = GtoResult

const LATE_POSITIONS = ['BTN', 'CO', 'HJ']

export function getExploitAction(state: GameState, stats: RawStats | null): ExploitResult {
  if (!stats || stats.vpip_denom < 5) {
    // Not enough data — return a reasonable default
    return {
      action: state.to_call_bb === 0 ? 'CHECK' : 'CALL',
      reasoning: 'Insufficient villain data — using conservative play',
    }
  }

  const vpip = stats.vpip_denom > 0 ? stats.vpip_num / stats.vpip_denom : 0.25
  const pfr = stats.pfr_denom > 0 ? stats.pfr_num / stats.pfr_denom : 0.15
  const af = stats.af_calls > 0 ? stats.af_bets / stats.af_calls : 1.0
  const foldTo3bet = stats.fold_to_3bet_denom > 0
    ? stats.fold_to_3bet_num / stats.fold_to_3bet_denom : 0.50
  const foldToCbet = stats.cbet_fold_denom > 0
    ? stats.cbet_fold_num / stats.cbet_fold_denom : 0.50

  const pos = (state.hero_position ?? '').toUpperCase()

  if (state.street === 'PREFLOP') {
    return getPreflopExploit({ vpip, pfr, foldTo3bet, pos, state })
  }
  return getPostflopExploit({ vpip, af, foldToCbet, state })
}

function getPreflopExploit(ctx: {
  vpip: number; pfr: number; foldTo3bet: number; pos: string; state: GameState
}): ExploitResult {
  const { vpip, pfr, foldTo3bet, pos, state } = ctx
  const hasRaise = state.action_history.some(a => a.toLowerCase().includes('raise'))
  const isLatePos = LATE_POSITIONS.includes(pos)

  // Wide steal exploitation
  if (!hasRaise && isLatePos && vpip < 0.20) {
    return {
      action: 'RAISE',
      sizing: '2.5x',
      reasoning: `Villain VPIP ${(vpip * 100).toFixed(0)}% — tight player, widen steal range from ${pos}`,
    }
  }

  // Bluff 3-bet exploitation
  if (hasRaise && foldTo3bet > 0.65 && isLatePos) {
    return {
      action: 'RAISE',
      sizing: '3x',
      reasoning: `Villain folds to 3-bets ${(foldTo3bet * 100).toFixed(0)}% of the time — profitable bluff 3-bet`,
    }
  }

  // Fish exploitation (wide caller)
  if (vpip > 0.40 && pfr < 0.10) {
    return {
      action: 'RAISE',
      sizing: '4x',  // Size up for value vs fish
      reasoning: `Villain VPIP ${(vpip * 100).toFixed(0)}%, PFR ${(pfr * 100).toFixed(0)}% — fish profile, size up for value`,
    }
  }

  return {
    action: hasRaise ? 'CALL' : 'RAISE',
    sizing: hasRaise ? undefined : '3x',
    reasoning: `Standard play vs this villain profile (VPIP: ${(vpip * 100).toFixed(0)}%, PFR: ${(pfr * 100).toFixed(0)}%)`,
  }
}

function getPostflopExploit(ctx: {
  vpip: number; af: number; foldToCbet: number; state: GameState
}): ExploitResult {
  const { vpip, af, foldToCbet, state } = ctx

  // High fold-to-cbet villain — fire c-bets more aggressively
  if (state.to_call_bb === 0 && foldToCbet > 0.65) {
    return {
      action: 'BET',
      sizing: '75% pot',
      reasoning: `Villain folds to c-bets ${(foldToCbet * 100).toFixed(0)}% — profitable bluff spot`,
    }
  }

  // Passive villain (low AF) — call down wider, reduce bluffs
  if (af < 0.8) {
    if (state.to_call_bb > 0) {
      return {
        action: 'CALL',
        reasoning: `Villain AF ${af.toFixed(2)} is passive — their bets are weighted toward value, call with decent equity`,
      }
    }
    return {
      action: 'BET',
      sizing: '50% pot',
      reasoning: `Villain AF ${af.toFixed(2)} — passive player will call down thinner, thin value bet`,
    }
  }

  // Fish (high VPIP, low AF) — thin value betting
  if (vpip > 0.40 && af < 1.2) {
    return {
      action: state.to_call_bb === 0 ? 'BET' : 'CALL',
      sizing: state.to_call_bb === 0 ? '60% pot' : undefined,
      reasoning: `Fish profile (VPIP ${(vpip * 100).toFixed(0)}%) — value bet thinly, they call too wide`,
    }
  }

  // Aggressive villain — pot control or check-raise
  if (af > 2.0) {
    return {
      action: 'CHECK',
      reasoning: `Villain AF ${af.toFixed(2)} is aggressive — pot control, induce bluffs with check`,
    }
  }

  return {
    action: state.to_call_bb > 0 ? 'CALL' : 'CHECK',
    reasoning: `Default exploit play vs this profile (VPIP: ${(vpip * 100).toFixed(0)}%, AF: ${af.toFixed(2)})`,
  }
}
